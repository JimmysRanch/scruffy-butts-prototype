<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Scruffy Butts</title>

    <!-- PWA basics -->
    <meta name="theme-color" content="#111111" />
    <link rel="manifest" href="manifest.json" />
    <!-- iOS PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Scruffy Butts" />
    <link rel="apple-touch-icon" href="icon-180.png" />

    <!-- Tailwind (CDN) for instant modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      /* iOS safe area padding for the header */
      .safe-top { padding-top: max(env(safe-area-inset-top), 12px); }
    </style>
  </head>
  <body class="bg-white text-zinc-900">
    <!-- Header -->
    <header class="safe-top sticky top-0 z-10 bg-white/80 backdrop-blur border-b border-zinc-200">
      <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-3">
        <img src="icon-180.png" alt="" class="size-8 rounded-lg" />
        <div>
          <h1 class="font-extrabold text-xl leading-5">Scruffy Butts</h1>
          <p class="text-xs text-zinc-500 -mt-0.5">Natalia, TX</p>
        </div>
      </div>
    </header>

    <!-- App Container -->
    <main class="max-w-5xl mx-auto px-4 py-5">
      <!-- Tabs -->
      <nav id="tabs" class="flex flex-wrap gap-2 mb-4"></nav>
      <!-- Screen -->
      <section id="screen" class="grid gap-3"></section>
    </main>

    <script>
      /********** State with localStorage persistence **********/
      const KEY = "sb_state_v1";
      const S = load() || { services:[], employees:[], clients:[], pets:[], appointments:[], messages:[], seeded:false };
      function save(){ localStorage.setItem(KEY, JSON.stringify(S)); }
      function load(){ try { return JSON.parse(localStorage.getItem(KEY) || ""); } catch { return null; } }

      const uid = () => Math.random().toString(36).slice(2);
      function seedIfNeeded(){
        if (S.seeded) return;
        S.services = [
          { id: uid(), name: 'Bath & Brush', price: 35, duration: 45, pct: 40 },
          { id: uid(), name: 'Full Groom (Small)', price: 65, duration: 75, pct: 50 },
          { id: uid(), name: 'Full Groom (Medium)', price: 85, duration: 90, pct: 50 },
          { id: uid(), name: 'Deshedding Add-on', price: 20, duration: 15, pct: 30 },
        ];
        S.employees = [
          { id: uid(), name: 'Taylor', phone: '+12105550101', role:'stylist', pctDefault:50, schedule: {1:[9,17],3:[9,17],5:[9,15]} },
          { id: uid(), name: 'Jordan', phone: '+12105550102', role:'stylist', pctDefault:45, schedule: {2:[10,18],4:[10,18]} },
          { id: uid(), name: 'Alex (Admin)', phone: '+12105550103', role:'admin', pctDefault:0, schedule:{} },
        ];
        S.clients = [
          { id: uid(), name: 'Jamie Lee', phone: '+12105550011', email: 'jamie@example.com' },
          { id: uid(), name: 'Chris P.',  phone: '+12105550012' }
        ];
        S.pets = [
          { id: uid(), clientId: S.clients[0].id, name: 'Buddy', breed:'Golden Retriever', notes:'Nervous at dryers' },
          { id: uid(), clientId: S.clients[0].id, name: 'Milo',  breed:'Poodle Mix' },
          { id: uid(), clientId: S.clients[1].id, name: 'Daisy', breed:'Yorkie' },
        ];
        const now = new Date(); now.setHours(10,0,0,0);
        S.appointments = [{
          id: uid(),
          clientId: S.clients[0].id,
          petId: S.pets[0].id,
          serviceId: S.services[0].id,
          employeeId: S.employees[0].id,
          start: now.toISOString(),
          end: new Date(now.getTime()+45*60000).toISOString(),
          status: 'booked'
        }];
        S.messages = [{
          id: uid(), from: '+1CLIENT', to: '+1SHOP', body: 'Hi! Can I book for Daisy on Fri at 10?', sentAt: new Date().toISOString()
        }];
        S.seeded = true;
        save();
      }

      /********** Tiny DOM helpers **********/
      const $ = sel => document.querySelector(sel);
      function el(tag, opts={}, ...kids){
        const n = document.createElement(tag);
        for (const [k,v] of Object.entries(opts)){
          if (k === 'class') n.className = v;
          else if (k === 'html') n.innerHTML = v;
          else if (k.startsWith('on')) n.addEventListener(k.slice(2).toLowerCase(), v);
          else n.setAttribute(k, v);
        }
        kids.flat().forEach(c => n.appendChild(c?.nodeType ? c : document.createTextNode(c ?? "")));
        return n;
      }

      /********** Tabs **********/
      let TAB = 'home';
      const tabs = [
        ['home','Home'], ['book','Book'], ['calendar','Calendar'],
        ['clients','Clients'], ['admin','Admin'], ['messages','Messages'],
        ['agreement','Agreement']
      ];
      function renderTabs(){
        const nav = $('#tabs'); nav.innerHTML = '';
        tabs.forEach(([id,label])=>{
          nav.appendChild(
            el('button', {
              class: `px-3 py-1.5 rounded-full border text-sm ${TAB===id ? 'bg-zinc-900 text-white border-zinc-900' : 'bg-white text-zinc-900 border-zinc-200'}`,
              onclick:()=>{ TAB=id; render(); }
            }, label)
          );
        });
      }

      /********** Screens **********/
      function ScreenHome(){
        return el('div', {class:'grid gap-3'},
          el('div', {class:'rounded-2xl border border-zinc-200 p-4 shadow-sm'},
            el('div', {class:'flex items-center gap-3'},
              el('img', {src:'icon-180.png', class:'size-12 rounded-xl', alt:''}),
              el('div', {},
                el('div', {class:'font-bold text-lg'}, 'Scruffy Butts'),
                el('div', {class:'text-xs text-zinc-500 -mt-0.5'}, 'Grooming • Deshedding • TLC')
              )
            )
          ),
          el('div', {class:'grid sm:grid-cols-3 gap-3'},
            cardLink('Book', 'Create an appointment', ()=>{TAB='book'; render();}),
            cardLink('Agreement', 'Digital consent & signature', ()=>{TAB='agreement'; render();}),
            cardLink('Messages', 'Two-way texting (demo)', ()=>{TAB='messages'; render();}),
          )
        );
      }
      function cardLink(title, desc, on){
        return el('button', {class:'text-left rounded-2xl border border-zinc-200 p-4 shadow-sm hover:shadow transition', onclick:on},
          el('div', {class:'font-semibold'}, title),
          el('div', {class:'text-sm text-zinc-500'}, desc)
        );
      }

      function ScreenBook(){
        seedIfNeeded();
        const state = { clientId:'', petId:'', serviceId:'', employeeId:'', start: new Date().toISOString().slice(0,16) };
        const petsFor = () => S.pets.filter(p=>p.clientId===state.clientId);

        function select(label, options, onChange, value=''){
          const sel = el('select', {class:'w-full border rounded-lg p-2', onchange:e=>onChange(e.target.value)});
          sel.appendChild(el('option', {value:''}, 'Select…'));
          options().forEach(o => sel.appendChild(el('option', {value:o.value, ...(value===o.value?{selected:''}:{})}, o.label)));
          return el('label', {class:'grid gap-1'}, el('span', {class:'text-xs text-zinc-500'}, label), sel);
        }

        const $client = select('Client', ()=> S.clients.map(c=>({value:c.id, label:c.name})), v=>{state.clientId=v; state.petId=''; rebuild();});
        const $pet    = () => select('Pet', ()=> petsFor().map(p=>({value:p.id, label:p.name})), v=>{state.petId=v;});
        const $svc    = select('Service', ()=> S.services.map(s=>({value:s.id, label:`${s.name} — $${s.price}`})), v=>{state.serviceId=v;});
        const $emp    = select('Employee', ()=> S.employees.filter(e=>e.role==='stylist').map(e=>({value:e.id, label:e.name})), v=>{state.employeeId=v;});
        const $start  = el('label', {class:'grid gap-1'},
                        el('span', {class:'text-xs text-zinc-500'}, 'Start'),
                        el('input', {type:'datetime-local', value:state.start, class:'w-full border rounded-lg p-2', oninput:e=>state.start=e.target.value }));

        const wrap = el('div', {class:'grid gap-3'});
        function rebuild(){
          wrap.innerHTML = '';
          wrap.appendChild($client);
          if (state.clientId) wrap.appendChild($pet());
          wrap.appendChild($svc); wrap.appendChild($emp); wrap.appendChild($start);
          wrap.appendChild(el('button', {
            class:'px-4 py-2 rounded-lg bg-zinc-900 text-white disabled:opacity-40',
            onclick: book, disabled: !(state.clientId && state.petId && state.serviceId && state.employeeId)
          }, 'Book Appointment'));
        }

        function book(){
          const svc = S.services.find(s=>s.id===state.serviceId);
          const start = new Date(state.start);
          const end = new Date(start.getTime() + (svc?.duration||60)*60000);
          S.appointments.push({
            id: uid(), clientId: state.clientId, petId: state.petId, serviceId: state.serviceId,
            employeeId: state.employeeId, start: start.toISOString(), end: end.toISOString(), status:'booked'
          });
          save();
          alert('Booked!');
          TAB='calendar'; render();
        }

        rebuild();
        return section('Book Appointment', wrap);
      }

      function ScreenCalendar(){
        seedIfNeeded();
        const day = { value: new Date().toISOString().slice(0,10) };

        function list(){ return S.appointments.filter(a => a.start.slice(0,10) === day.value).sort((a,b)=>a.start.localeCompare(b.start)); }
        const dateI = el('input', {type:'date', value: day.value, class:'border rounded-lg p-2', oninput:e=>{day.value=e.target.value; rebuild();} });
        const listEl = el('div', {class:'grid gap-2'});

        function fmt(iso){ return new Date(iso).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
        function row(a){
          const c = S.clients.find(c=>c.id===a.clientId)?.name || 'Client';
          const p = S.pets.find(p=>p.id===a.petId)?.name || 'Pet';
          const s = S.services.find(s=>s.id===a.serviceId)?.name || 'Service';
          const e = S.employees.find(e=>e.id===a.employeeId)?.name || 'Stylist';
          return el('div', {class:'rounded-2xl border border-zinc-200 p-3 flex items-center justify-between'},
            el('div', {},
              el('div', {class:'font-semibold'}, `${c} – ${p}`),
              el('div', {class:'text-xs text-zinc-500'}, s),
              el('div', {class:'text-sm'}, `${fmt(a.start)} – ${fmt(a.end)} • ${e}`),
              el('span', {class:'inline-block text-xs mt-1 px-2 py-0.5 rounded-full border'}, a.status)
            ),
            el('div', {class:'flex gap-2'},
              btn('Complete', ()=>{a.status='complete'; save(); rebuild();}, 'bg-green-600 text-white'),
              btn('Cancel', ()=>{a.status='canceled'; save(); rebuild();}, 'bg-red-600 text-white')
            )
          );
        }

        function btn(label, on, classes='bg-white'){
          return el('button', {class:`px-3 py-1.5 rounded-lg border ${classes==='bg-white'?'':'border-transparent'} ${classes}`, onclick:on}, label);
        }

        function rebuild(){
          listEl.innerHTML = '';
          const items = list();
          if (!items.length) listEl.appendChild(el('div', {class:'text-sm text-zinc-500'}, 'No appointments for this date.'));
          items.forEach(a => listEl.appendChild(row(a)));
        }

        rebuild();
        return section('Calendar', el('div', {class:'grid gap-3'}, el('div', {}, dateI), listEl));
      }

      function ScreenClients(){
        seedIfNeeded();
        const wrap = el('div', {class:'grid gap-2'});
        S.clients.forEach(c=>{
          wrap.appendChild(
            el('div', {class:'rounded-2xl border border-zinc-200 p-3'},
              el('div', {class:'font-semibold'}, c.name),
              el('div', {class:'text-xs text-zinc-500'}, c.phone + (c.email?` • ${c.email}`:'')),
              el('div', {class:'text-sm mt-1'}, 'Pets: ' + (S.pets.filter(p=>p.clientId===c.id).map(p=>p.name).join(', ') || '—'))
            )
          );
        });
        return section('Clients', wrap);
      }

      function ScreenAdmin(){
        seedIfNeeded();
        const range = {
          start: new Date(Date.now()-7*86400000).toISOString().slice(0,10),
          end:   new Date().toISOString().slice(0,10)
        };
        const startI = el('input', {type:'date', value:range.start, class:'border rounded-lg p-2', oninput:e=>{range.start=e.target.value; redraw();}});
        const endI   = el('input', {type:'date', value:range.end,   class:'border rounded-lg p-2', oninput:e=>{range.end=e.target.value; redraw();}});
        const payEl  = el('div', {class:'grid gap-2'});
        const scheds = el('div', {class:'grid gap-2'});

        function inRange(iso){ const d=iso.slice(0,10); return d>=range.start && d<=range.end; }
        function payroll(){
          const lines = {};
          for (const a of S.appointments){
            if (a.status!=='complete' || !inRange(a.start)) continue;
            const svc = S.services.find(s=>s.id===a.serviceId); if(!svc) continue;
            const key = a.employeeId;
            if (!lines[key]) lines[key] = { name:'', rev:0, pct: svc.pct };
            lines[key].rev += svc.price; lines[key].pct = svc.pct;
          }
          return lines;
        }

        function redraw(){
          // payroll
          payEl.innerHTML = '';
          const lines = payroll();
          const entries = Object.entries(lines);
          if (!entries.length) payEl.appendChild(el('div', {class:'text-sm text-zinc-500'}, 'No completed appointments in range.'));
          entries.forEach(([empId, v])=>{
            const emp = S.employees.find(e=>e.id===empId);
            const stylist = v.rev * (v.pct/100);
            const house = v.rev - stylist;
            payEl.appendChild(
              el('div', {class:'rounded-2xl border border-zinc-200 p-3'},
                el('div', {class:'font-semibold'}, emp?.name || 'Employee'),
                el('div', {class:'text-sm'}, `Revenue: $${v.rev.toFixed(2)} • ${v.pct}%`),
                el('div', {class:'text-sm'}, `Stylist: $${stylist.toFixed(2)} • House: $${house.toFixed(2)}`)
              )
            );
          });

          // schedules
          scheds.innerHTML = '';
          S.employees.forEach(e=>{
            const scheduleText = Object.keys(e.schedule).length
              ? Object.entries(e.schedule).map(([d,[o,c]]) => `${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][+d]}: ${o}:00–${c}:00`).join(' • ')
              : 'No hours set';
            scheds.appendChild(
              el('div', {class:'rounded-2xl border border-zinc-200 p-3'},
                el('div', {class:'font-semibold'}, e.name),
                el('div', {class:'text-sm'}, scheduleText)
              )
            );
          });
        }

        redraw();
        return section('Admin',
          el('div', {class:'grid gap-6'},
            el('div', {},
              el('div', {class:'font-medium mb-2'}, 'Range'),
              el('div', {class:'flex gap-2'}, startI, endI)
            ),
            el('div', {}, el('div', {class:'font-medium mb-2'}, 'Payroll Summary'), payEl),
            el('div', {}, el('div', {class:'font-medium mb-2'}, 'Employee Schedules (weekly)'), scheds)
          )
        );
      }

      function ScreenMessages(){
        seedIfNeeded();
        const thread = el('div', {class:'rounded-2xl border border-zinc-200 p-3 h-72 overflow-auto bg-zinc-50'});
        const input  = el('input', {class:'flex-1 border rounded-lg p-2', placeholder:'Type message…'});
        const send   = el('button', {class:'px-4 py-2 rounded-lg bg-zinc-900 text-white disabled:opacity-40'}, 'Send');

        function redraw(){
          thread.innerHTML = '';
          (S.messages||[]).forEach(m=>{
            thread.appendChild(
              el('div', {class:'mb-2'},
                el('div', {class:'inline-block rounded-lg border border-zinc-200 bg-white px-2 py-1'}, m.body),
                el('div', {class:'text-[10px] text-zinc-500'}, new Date(m.sentAt).toLocaleTimeString())
              )
            );
          });
          if (!S.messages.length) thread.appendChild(el('div', {class:'text-sm text-zinc-500'}, 'No messages yet.'));
        }
        redraw();

        send.addEventListener('click', ()=>{
          const text = input.value.trim(); if (!text) return;
          S.messages.push({ id: uid(), from:'+1SHOP', to:'+1CLIENT', body:text, sentAt:new Date().toISOString() });
          input.value=''; save(); redraw();
        });

        return section('Messages', el('div', {class:'grid gap-3'}, thread, el('div', {class:'flex gap-2'}, input, send)));
      }

      function ScreenAgreement(){
        const text = el('textarea', {class:'w-full border rounded-xl p-3 min-h-[140px]'},
          'I consent to grooming services and acknowledge the policies including cancellation, matted coat fees, and emergency care authorization.'
        );
        const canvas = el('canvas', {class:'w-full h-[220px] rounded-xl bg-white border border-zinc-200'});
        const ctx = canvas.getContext('2d');
        let drawing=false;
        function resize(){
          const ratio = window.devicePixelRatio || 1;
          const w = canvas.clientWidth; const h = 220;
          canvas.width = w * ratio; canvas.height = h * ratio; ctx.setTransform(ratio,0,0,ratio,0,0);
        }
        setTimeout(resize,0); window.addEventListener('resize', resize);
        canvas.addEventListener('mousedown',e=>{drawing=true;ctx.beginPath();ctx.moveTo(e.offsetX,e.offsetY);});
        canvas.addEventListener('mousemove',e=>{ if(!drawing)return; ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#111'; ctx.lineTo(e.offsetX,e.offsetY); ctx.stroke(); ctx.beginPath(); ctx.moveTo(e.offsetX,e.offsetY);});
        window.addEventListener('mouseup',()=>drawing=false);

        const preview = el('div', {});
        const saveBtn = button('Save', ()=>{ const url = canvas.toDataURL('image/png'); preview.innerHTML=''; preview.appendChild(el('img', {src:url, class:'max-h-28 rounded-xl border border-zinc-200'})); });
        const clearBtn= button('Clear', ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); preview.innerHTML=''; });

        const addPhotos = button('Add Photos', ()=>alert('Uploads will be enabled when hooked to a backend.'));
        const addDocs   = button('Add Docs', ()=>alert('Uploads will be enabled when hooked to a backend.'));
        const submit    = el('button', {class:'px-4 py-2 rounded-lg bg-zinc-900 text-white'}, 'Submit Agreement');

        return section('Agreement',
          el('div', {class:'grid gap-4'},
            el('div', {}, text),
            el('div', {}, el('div', {class:'font-medium mb-1'}, 'Signature'), canvas, el('div', {class:'flex gap-2 mt-2'}, saveBtn, clearBtn), preview),
            el('div', {}, el('div', {class:'font-medium mb-1'}, 'Attachments (photos/docs)'), el('div', {class:'flex gap-2'}, addPhotos, addDocs), el('p', {class:'text-xs text-zinc-500 mt-1'}, 'Uploads are placeholders.')),
            submit
          )
        );
      }

      /********** UI helpers **********/
      function section(title, body){
        return el('div', {class:'grid gap-3'},
          el('h2', {class:'text-2xl font-bold'}, title),
          body
        );
      }

      /********** Router **********/
      function render(){
        renderTabs();
        const screen = $('#screen'); screen.innerHTML = '';
        const map = {
          home: ScreenHome, book: ScreenBook, calendar: ScreenCalendar,
          clients: ScreenClients, admin: ScreenAdmin, messages: ScreenMessages,
          agreement: ScreenAgreement
        };
        screen.appendChild(map[TAB]());
      }

      // boot
      seedIfNeeded();
      render();

      // PWA: register service worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').catch(()=>{});
      }
    </script>
  </body>
</html>
