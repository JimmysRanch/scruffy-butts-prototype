<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Scruffy Butts</title>

  <!-- PWA -->
  <meta name="theme-color" content="#111111" />
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Scruffy Butts" />
  <link rel="apple-touch-icon" href="icon-180.png" />

  <!-- Brand font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50:'#f0f7ff',100:'#dff0ff',200:'#bee0ff',300:'#93ccff',
              400:'#5fb3ff',500:'#2e9bff',600:'#197fe0',700:'#1262b1',800:'#0f4c8a',900:'#0c3d70'
            },
            pop: { 100:'#ffe6f3', 500:'#ff67b3', 600:'#ff4da7', 700:'#e63e96' }
          },
          fontFamily: {
            sans: ['Inter','system-ui','ui-sans-serif','Segoe UI','Roboto','Helvetica','Arial']
          },
          boxShadow: { card: '0 10px 30px -12px rgba(0,0,0,.25)' },
          borderRadius: { xl2: '1.25rem' }
        }
      }
    }
  </script>

  <style>
    .safe-top { padding-top: max(env(safe-area-inset-top), 12px); }
    .tap { -webkit-tap-highlight-color: transparent; }
    .hit { min-height: 44px; min-width: 44px; }
    .anim { transition: all .18s ease; }
    .link { color:#197fe0; }
    .chip { @apply inline-block text-xs px-2 py-0.5 rounded-full border; }
  </style>
</head>
<body class="bg-white text-zinc-900">
  <div id="app" class="min-h-screen"></div>

  <script>
/* ===== dev error overlay (like Swift red errors) ===== */
window.onerror = function (msg, src, line, col, err) {
  const d = document.createElement('div');
  d.style.cssText = 'position:fixed;z-index:99999;inset:0;background:rgba(255,0,0,.9);color:#fff;font:16px/1.4 monospace;padding:16px;overflow:auto;';
  d.innerHTML = '<h2 style="margin:0 0 12px;font-size:20px;">‚ùå JavaScript Error</h2>'
    + '<div><b>Message:</b> ' + msg + '</div>'
    + '<div><b>File:</b> ' + src + '</div>'
    + '<div><b>Line:</b> ' + line + ':' + col + '</div>'
    + '<pre style="white-space:pre-wrap;margin-top:12px;background:#000;padding:12px;border-radius:8px;">'
    + (err && err.stack ? err.stack : '') + '</pre>';
  document.body.appendChild(d);
};

/* ===== state + seed (localStorage) ===== */
/* ===== supabase (live data) ===== */
const SUPABASE_URL = 'https://tzbybtluhzntfhjexptw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6YnlidGx1aHpudGZoamV4cHR3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0MTkxNzIsImV4cCI6MjA3MTk5NTE3Mn0.E-2Y9CupjktT67UwkCP3Bm7-cBDmkolk2RIo_sPyRHQ';
const supa = (window.supabase && SUPABASE_URL && SUPABASE_ANON_KEY)
  ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
  : null;

// normalize any row from Supabase to what UI expects
const normalize = (r) => {
  const time = (r.when_time || '09:00').padStart(5, '0'); // HH:MM
  const startISO = `${r.when_date}T${time}:00`;
  return {
    id: r.id,
    start: startISO,
    end:   startISO,
    status: r.status || 'booked',
    clientName: r.owner_name || r.client_name || 'Client',
    petName:    r.dog_name   || 'Pet',
    serviceName:r.service    || r.service_name || 'Service',
    employeeName: r.employee_name || 'Stylist'
  };
};
    
    const KEY="sb_state_v1";
const S = JSON.parse(localStorage.getItem(KEY) || "null") || {
  services:[], employees:[], clients:[], pets:[], appointments:[], messages:[], seeded:false
};
const STATUSES = ['booked','checked-in','in-progress','ready','complete','canceled']; // shared list
const uid = () => Math.random().toString(36).slice(2);
const save = ()=>localStorage.setItem(KEY, JSON.stringify(S));

function mkAppt(c,p,s,e,start){
  return {
    id:uid(),
    clientId:c.id, petId:p.id, serviceId:s.id, employeeId:e.id,
    notes:'', // free text notes (cut length when persisting later if needed)
    status:'booked',
    start:start.toISOString(),
    end:new Date(start.getTime()+s.duration*60000).toISOString()
  };
}

function seed(){
  if (S.seeded) return;
  S.services = [
    { id: uid(), name: 'Bath & Brush',        price: 35, duration: 45, pct: 40 },
    { id: uid(), name: 'Full Groom (Small)',  price: 65, duration: 75, pct: 50 },
    { id: uid(), name: 'Full Groom (Medium)', price: 85, duration: 90, pct: 50 },
    { id: uid(), name: 'Deshedding Add-on',   price: 20, duration: 15, pct: 30 },
  ];
  S.employees = [
    { id: uid(), name: 'Taylor', role:'stylist', pctDefault:50, schedule:{1:[9,17],3:[9,17],5:[9,15]} },
    { id: uid(), name: 'Jordan', role:'stylist', pctDefault:45, schedule:{2:[10,18],4:[10,18]} },
  ];
  S.clients = [
    { id: uid(), name: 'Sarah Jones',  phone:'+12105550001', signed:true },
    { id: uid(), name: 'Emily Wilson', phone:'+12105550002', signed:false },
    { id: uid(), name: 'David Smith',  phone:'+12105550003', signed:true },
  ];
  S.pets = [
    { id: uid(), clientId:S.clients[0].id, name:'Rocky' },
    { id: uid(), clientId:S.clients[1].id, name:'Bella' },
    { id: uid(), clientId:S.clients[2].id, name:'Luna'  },
  ];
  const t=new Date(); t.setHours(9,0,0,0);
  S.appointments = [
    mkAppt(S.clients[0], S.pets[0], S.services[2], S.employees[0], t),
    mkAppt(S.clients[1], S.pets[1], S.services[0], S.employees[1], new Date(t.getTime()+3*3600000)),
    mkAppt(S.clients[2], S.pets[2], S.services[1], S.employees[0], new Date(t.getTime()+6*3600000)),
  ];
  S.messages = [{ id:uid(), body:"Hi! Can I book Friday at 10?", sentAt:new Date().toISOString() }];
  S.seeded = true; save();
}

/* ===== tiny DOM helpers ===== */
const $ = s => document.querySelector(s);
function el(tag, props={}, ...kids){
  const n=document.createElement(tag);
  Object.entries(props).forEach(([k,v])=>{
    if(k==='class') n.className=v;
    else if(k==='html') n.innerHTML=v;
    else if(k.startsWith('on')) n.addEventListener(k.slice(2).toLowerCase(),v);
    else n.setAttribute(k,v);
  });
  kids.flat().forEach(c=>n.appendChild(c?.nodeType?c:document.createTextNode(c??"")));
  return n;
}
const fmtTime = iso => new Date(iso).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
const fmtDate = iso => new Date(iso).toLocaleDateString();

/* ===== date helpers ===== */
const toISODate   = d => new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);
const addDays     = (d,n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x; };
const startOfWeek = (d) => { const x=new Date(d); const diff=x.getDay(); x.setDate(x.getDate()-diff); x.setHours(0,0,0,0); return x; };
const daysInMonth = (y,m) => new Date(y, m+1, 0).getDate();

/* ===== mini-router (replaces TAB) =====
   routes: dashboard | book | calendar | clients | admin | messages | agreement
           appt/:id  | client/:id
*/
const Nav = { route:'dashboard', id:null, aux:null };
function goto(route, id=null, aux=null){ Nav.route=route; Nav.id=id; Nav.aux=aux; render(); }
// quick getters
const byId       = (arr, id) => arr.find(x => x.id === id);
const getClient  = id => byId(S.clients, id);
const getPet     = id => byId(S.pets, id);
const getService = id => byId(S.services, id);
const getEmployee= id => byId(S.employees, id);
const getAppt    = id => byId(S.appointments, id);

/* ===== sidebar ===== */
function Sidebar(){
  const Item = (route, label, icon) => el('button', {
    class:`w-full flex items-center gap-3 px-3 py-2 rounded-xl text-left hit tap anim
           ${Nav.route===route?'bg-white/95 text-zinc-900 shadow-card':'text-white/90 hover:bg-white/10'}`,
    onclick:()=>goto(route)
  }, el('span',{class:'text-lg'},icon), el('span',{},label));

  return el('aside',{
class:'w-[250px] shrink-0 bg-gradient-to-b from-brand-600 to-brand-800 text-white px-4 pb-4 pt-10 md:pt-14 space-y-4 hidden md:block'
  },
    el('div',{class:'flex items-center gap-3'},
      el('img',{src:'icon-180.png', class:'w-12 h-12 rounded-xl shadow-card', alt:''}),
      el('div',{},
        el('div',{class:'font-extrabold text-xl leading-5'},'Scruffy Butts'),
        el('div',{class:'text-xs text-white/80 -mt-0.5'},'Natalia, TX')
      )
    ),
    el('nav',{class:'space-y-2 pt-2'},
      Item('dashboard','Dashboard','üè†'),
      Item('book','Book','üìÖ'),
      Item('calendar','Calendar','üóìÔ∏è'),
      Item('clients','Clients','üë§'),
      Item('admin','Reports','üìä'),
      Item('messages','Messages','üí¨'),
      Item('agreement','Agreement','‚úçÔ∏è')
    )
  );
}

/* ===== themed cards / bits ===== */
function Card(title, body){
  return el('div',{class:'rounded-xl2 border border-zinc-200 bg-white shadow-card overflow-hidden'},
    el('div',{class:'px-4 py-2 font-semibold bg-pop-100 text-pop-700'}, title),
    el('div',{class:'p-4'}, body)
  );
}
const KPI = (label, value, icon) =>
  el('div',{class:'rounded-xl2 border border-zinc-200 bg-white p-4 flex items-center gap-3 shadow-card'},
    el('div',{class:'text-2xl'},icon),
    el('div',{}, el('div',{class:'text-xs text-zinc-500'},label), el('div',{class:'font-bold text-xl'}, value))
  );

function Breadcrumb(items){
  // items: [{label, click}]
  const parts = [];
  items.forEach((it,i)=>{
    if(i) parts.push(el('span',{class:'mx-1 text-zinc-400'},'‚Ä∫'));
    parts.push(el('button',{class:'link',onclick:it.click},it.label));
  });
  return el('div',{class:'text-sm mb-2'}, ...parts);
}

/* ===== dashboard ===== */
function AppointmentsCard(){
  const today = new Date().toISOString().slice(0,10);
  const appts = S.appointments.filter(a=>a.start.slice(0,10)===today).sort((a,b)=>a.start.localeCompare(b.start));
  const Row = a => {
    const pet = getPet(a.petId)?.name || 'Pet';
    const dot = {booked:'bg-brand-500', 'checked-in':'bg-sky-500', 'in-progress':'bg-amber-500',
                 ready:'bg-violet-500', complete:'bg-emerald-600', canceled:'bg-rose-500'}[a.status] || 'bg-zinc-400';
    return el('button',{class:'w-full flex items-center justify-between py-1 text-left hover:bg-zinc-50 rounded-lg px-1',
                        onclick:()=>goto('appt', a.id)},
      el('div',{class:'flex items-center gap-2'},
        el('span',{class:`inline-block w-2 h-2 rounded-full ${dot}`}),
        el('span',{},pet)
      ),
      el('div',{class:'text-sm text-zinc-700'}, fmtTime(a.start))
    );
  };
  return Card('Today‚Äôs Appointments', el('div',{class:'divide-y divide-zinc-100'},
    ...appts.map(Row),
    !appts.length && el('div',{class:'text-sm text-zinc-500 py-2'},'No appointments today.')
  ));
}
function CustomersCard(){
  const names = S.clients.map(c=>c);
  const grid = el('div',{class:'grid grid-cols-2 gap-x-6 gap-y-1 text-sm'},
    ...names.map(c=>el('button',{class:'text-left hover:underline',onclick:()=>goto('client',c.id)}, c.name)));
  return Card('Customer List', grid);
}
function PromoCard(){
  return Card('Upcoming Services',
    el('div',{class:'flex items-center gap-3'},
      el('div',{class:'w-28 h-20 rounded-xl bg-brand-50 flex items-center justify-center text-3xl'},'üê∂'),
      el('div',{}, el('div',{class:'font-semibold'},'Full Grooming'), el('div',{class:'text-sm text-zinc-500'},'2:00 PM'))
    )
  );
}
function ReportsCard(){
  const vals=[120,180,220,300,420], max=Math.max(...vals);
  const bars = vals.map((v,i)=>el('rect',{x: i*26+24, y: 120 - (v/max)*100, width:20, height:(v/max)*100, rx:4, class:'fill-brand-400'}));
  const svg = el('svg',{viewBox:'0 0 170 130', class:'w-full h-28'}, ...bars);
  return Card('Reports', svg);
}
function Dashboard(){
  const todayCount = S.appointments.filter(a=>a.start.slice(0,10)===new Date().toISOString().slice(0,10)).length;
  return el('div',{class:'flex-1 p-4 md:p-6'},
    el('h1',{class:'text-3xl font-extrabold mb-4'},'Dashboard'),
    el('div',{class:'grid sm:grid-cols-4 gap-3 mb-4'},
      KPI("Today's Appointments", todayCount,'üìÖ'),
      KPI('New Clients', S.clients.length,'üë§'),
      KPI('Completed', '$850','‚úÖ'),
      KPI('Upcoming Services', 7,'üêï')
    ),
    el('div',{class:'grid lg:grid-cols-2 gap-4'},
      el('div',{class:'grid gap-4'}, AppointmentsCard(), CustomersCard()),
      el('div',{class:'grid gap-4'}, PromoCard(), ReportsCard())
    )
  );
}

/* ===== book ===== */
function Book(){
  return el('div',{class:'flex-1 p-0'},
    el('iframe',{
      src:'https://scruffy-butts-pwa-final.vercel.app', // redirects to /book
      class:'w-full', style:'height: calc(100vh - 24px); border: 0;',
      title:'Scruffy Butts Booking', loading:'eager', referrerpolicy:'no-referrer-when-downgrade', allow:'clipboard-write'
    })
  );
}

/* ===== calendar (day/week/month) ‚Äî pulls from Supabase when available ===== */
function Calendar(){
  seed();
  const state = { view:'day', focus:new Date() };

  // cache of live appts keyed by ISO date (YYYY-MM-DD)
  const LIVE = new Map();

  const root  = el('div',{class:'flex-1 p-4 md:p-6'});
  const title = el('h1',{class:'text-3xl font-extrabold mb-2'},'Calendar');
  const crumbs= Breadcrumb([{label:'Dashboard', click:()=>goto('dashboard')}, {label:'Calendar', click:()=>goto('calendar')}]);
  const toolbar = el('div',{class:'flex flex-wrap gap-2 items-center mb-3'});
  const content = el('div',{class:'grid gap-3'});

  const btn = (label, on, cls='') => el('button',{ class:`px-3 py-1.5 rounded-xl border anim tap ${cls||'bg-white hover:bg-zinc-50'}`, onclick:on }, label);
  const todayBtn = btn('Today', ()=>{ state.focus=new Date(); rebuild(); maybeLoad(); }, 'bg-brand-600 hover:bg-brand-700 text-white border-transparent');
  const prevBtn  = btn('‚óÄÔ∏é', ()=>{ nav(-1); });
  const nextBtn  = btn('‚ñ∂Ô∏é', ()=>{ nav(+1); });
  const toggle = el('div',{class:'inline-flex rounded-xl overflow-hidden border'},
    tabBtn('Day'), tabBtn('Week'), tabBtn('Month')
  );

  function tabBtn(name){
    const id=name.toLowerCase();
    return el('button',{
      class:`px-3 py-1.5 text-sm ${state.view===id ? 'bg-brand-600 text-white' : 'bg-white hover:bg-zinc-50'}`,
      onclick:()=>{ state.view=id; rebuild(); maybeLoad(); }
    }, name);
  }

  function nav(dir){
    const f=state.focus;
    if (state.view==='day')   state.focus = addDays(f, dir);
    if (state.view==='week')  state.focus = addDays(f, dir*7);
    if (state.view==='month') state.focus = new Date(f.getFullYear(), f.getMonth()+dir, 1);
    rebuild(); maybeLoad();
  }

  function headerLabel(){
    const f=state.focus;
    const fmt = (o)=>f.toLocaleDateString([],o);
    if (state.view==='day')   return fmt({weekday:'long', month:'long', day:'numeric', year:'numeric'});
    if (state.view==='week')  { const s=startOfWeek(f), e=addDays(s,6);
      return `${s.toLocaleDateString([], {month:'short', day:'numeric'})} ‚Äì ${e.toLocaleDateString([], {month:'short', day:'numeric', year:'numeric'})}`; }
    return f.toLocaleDateString([], {month:'long', year:'numeric'});
  }



  function apptsForDateISO(isoDate){
    // prefer live data; else fall back to local seeded data
    if (LIVE.has(isoDate)) return LIVE.get(isoDate);
    return S.appointments
      .filter(a=>a.start.slice(0,10)===isoDate)
      .map(a=>({
        id:a.id,
        start:a.start, end:a.end, status:a.status,
        clientName: getClient(a.clientId)?.name ?? 'Client',
        petName:    getPet(a.petId)?.name ?? 'Pet',
        serviceName:getService(a.serviceId)?.name ?? 'Service',
        employeeName:getEmployee(a.employeeId)?.name ?? 'Stylist'
      }))
      .sort((a,b)=>a.start.localeCompare(b.start));
  }

  async function maybeLoad(){
    if (!supa) return; // no keys / SDK ‚Äî stay on local data
    // determine range we need
    const f = state.focus;
    let start, end;
    if (state.view==='day')   { start = toISODate(f); end = start; }
    if (state.view==='week')  { const s=startOfWeek(f); start=toISODate(s); end=toISODate(addDays(s,6)); }
    if (state.view==='month') {
      const first = new Date(f.getFullYear(), f.getMonth(), 1);
      const last  = new Date(f.getFullYear(), f.getMonth()+1, 0);
      start = toISODate(first); end = toISODate(last);
    }

    const rows = await fetchAppointmentsRange(start, end);
    if (!rows) return; // network/RLS issue ‚Üí keep local
    // fill cache
    const bucket = {};
    rows.map(normalize).forEach(r=>{
      const d = r.start.slice(0,10);
      (bucket[d] ||= []).push(r);
    });
    Object.entries(bucket).forEach(([d,list])=>{
      LIVE.set(d, list.sort((a,b)=>a.start.localeCompare(b.start)));
    });
    rebuild(); // re-render with live data
  }

  function buildDay(){
    const d = toISODate(state.focus);
    const list = apptsForDateISO(d);
    const wrap = el('div',{class:'grid gap-2'});
    if (!list.length) wrap.appendChild(el('div',{class:'text-sm text-zinc-500'},'No appointments for this day.'));
    list.forEach(a=>{
      const {clientName, petName, serviceName, employeeName} = a;
      wrap.appendChild(
        el('button',{class:'text-left rounded-xl2 border border-zinc-200 p-3 bg-white shadow-card hover:bg-zinc-50',
                     onclick:()=>goto('appt', a.id)},
          el('div',{class:'font-semibold'},`${clientName} ‚Äì ${petName}`),
          el('div',{class:'text-xs text-zinc-500'},serviceName),
          el('div',{class:'text-sm'},`${fmtTime(a.start)} ‚Äì ${fmtTime(a.end)} ‚Ä¢ ${employeeName}`),
          el('span',{class:'inline-block text-xs mt-1 px-2 py-0.5 rounded-full border'},a.status)
        )
      );
    });
    return wrap;
  }

  function buildWeek(){
    const start = startOfWeek(state.focus);
    const days = [...Array(7)].map((_,i)=>addDays(start,i));
    const head = el('div',{class:'grid grid-cols-7 text-sm font-semibold mb-2'},
      ...days.map(d=>el('div',{class:'text-center'}, d.toLocaleDateString([], {weekday:'short'})+'\n'+d.getDate()))
    );
    const grid = el('div',{class:'grid grid-cols-7 gap-2'});
    days.forEach(d=>{
      const iso = toISODate(d);
      const appts = apptsForDateISO(iso);
      const col = el('div',{class:'rounded-xl border border-zinc-200 bg-white p-2 min-h-[110px] shadow-sm'});
      if (!appts.length) col.appendChild(el('div',{class:'text-xs text-zinc-400 text-center mt-6'},'‚Äî'));
      appts.forEach(a=>{
        col.appendChild(el('button',{class:'block w-full text-left text-xs rounded-lg border px-2 py-1 mb-1 bg-brand-50 border-brand-200 hover:bg-brand-100',
                      onclick:()=>goto('appt',a.id)}, `${fmtTime(a.start)} ‚Ä¢ ${a.petName}`));
      });
      grid.appendChild(col);
    });
    return el('div',{}, head, grid);
  }

  function buildMonth(){
    const f = state.focus; const y=f.getFullYear(), m=f.getMonth();
    const first = new Date(y,m,1); const start = startOfWeek(first);
    const cells = [...Array(42)].map((_,i)=>addDays(start,i)); // 6 rows
    const head = el('div',{class:'grid grid-cols-7 text-xs font-semibold text-zinc-500 mb-1'},
      ...['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d=>el('div',{class:'text-center'},d))
    );
    const grid = el('div',{class:'grid grid-cols-7 gap-1'});
    cells.forEach(d=>{
      const inMonth = d.getMonth()===m; const iso = toISODate(d);
      const appts = apptsForDateISO(iso);
      grid.appendChild(
        el('button',{class:`text-left rounded-lg p-2 border hit tap anim
                           ${inMonth?'bg-white border-zinc-200':'bg-zinc-50 border-zinc-200 opacity-60'} hover:bg-zinc-50`,
                     onclick:()=>{ state.focus=d; state.view='day'; rebuild(); }},
          el('div',{class:'flex justify-between items-center mb-1'},
            el('span',{class:'text-xs text-zinc-500'}, d.getDate()),
            appts.length ? el('span',{class:'text-[10px] rounded-full px-1.5 py-0.5 bg-brand-600 text-white'}, appts.length) : ''
          )
        )
      );
    });
    return el('div',{}, head, grid);
  }

  function rebuild(){
    toolbar.innerHTML='';
    toolbar.appendChild(prevBtn);
    toolbar.appendChild(nextBtn);
    toolbar.appendChild(todayBtn);
    toolbar.appendChild(el('span',{class:'mx-2 font-semibold'}, headerLabel()));
    toolbar.appendChild(el('span',{class:'flex-1'}));
    toolbar.appendChild(toggle);

    content.innerHTML='';
    if (state.view==='day')   content.appendChild(buildDay());
    if (state.view==='week')  content.appendChild(buildWeek());
    if (state.view==='month') content.appendChild(buildMonth());
  }

  // initial paint + try to load live data
  rebuild();
  root.appendChild(title); root.appendChild(crumbs); root.appendChild(toolbar); root.appendChild(content);
  maybeLoad();
  return root;
}
    
/* ===== appointment detail ===== */
function AppointmentDetail(id){
  const a = getAppt(id);
  if(!a) return el('div',{class:'p-6'},'Appointment not found.');
  const c=getClient(a.clientId), p=getPet(a.petId), s=getService(a.serviceId), e=getEmployee(a.employeeId);

  const statusSel = el('select',{class:'border rounded-xl p-2'},
    ...STATUSES.map(st => el('option',{value:st, selected:st===a.status}, st))
  );
  statusSel.addEventListener('change',()=>{ a.status=statusSel.value; save(); render(); });

  const notes = el('textarea',{class:'w-full border rounded-xl p-2',rows:3,value:a.notes||''});
  notes.addEventListener('input',()=>{ a.notes = notes.value.slice(0,300); save(); });

  const header = el('div',{class:'flex items-center justify-between mb-2'},
    el('div',{class:'text-sm'}, Breadcrumb([
      {label:'Dashboard', click:()=>goto('dashboard')},
      {label:'Calendar',  click:()=>goto('calendar')},
      {label:`Appt ${fmtDate(a.start)}`, click:()=>goto('appt',a.id)}
    ])),
    el('button',{class:'px-3 py-1 rounded-xl border', onclick:()=>goto('calendar')},'Back to Calendar')
  );

  const body = el('div',{class:'grid md:grid-cols-2 gap-4'},
    Card('Client',
      el('div',{},
        el('div',{}, el('button',{class:'link',onclick:()=>goto('client', c.id)}, c.name)),
        el('div',{class:'text-sm text-zinc-600'}, c.phone || ''),
        el('div',{class:'text-sm mt-1'}, 'Pet: ' + (p?.name||''))
      )
    ),
    Card('Service',
      el('div',{},
        el('div',{}, s?.name||''),
        el('div',{class:'text-sm text-zinc-600'}, `With ${e?.name||''}`),
        el('div',{class:'text-sm'}, `${fmtTime(a.start)} ‚Äì ${fmtTime(a.end)} (${fmtDate(a.start)})`)
      )
    ),
    Card('Status',
      el('div',{}, el('div',{class:'mb-2'},'Update status:'), statusSel)
    ),
    Card('Notes',
      el('div',{}, notes)
    )
  );

  return el('div',{class:'flex-1 p-4 md:p-6'},
    el('h1',{class:'text-3xl font-extrabold mb-2'},'Appointment'),
    header,
    body
  );
}

/* ===== client detail ===== */
function ClientDetail(id){
  const c = getClient(id);
  if(!c) return el('div',{class:'p-6'},'Client not found.');
  const pets = S.pets.filter(p=>p.clientId===id);
  const appts = S.appointments.filter(a=>a.clientId===id).sort((a,b)=>b.start.localeCompare(a.start));

  const signBadge = c.signed
    ? el('span',{class:'inline-block text-xs px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-800 border border-emerald-300 ml-2'},'Agreement on file')
    : el('span',{class:'inline-block text-xs px-2 py-0.5 rounded-full bg-rose-100 text-rose-800 border border-rose-300 ml-2'},'Agreement missing');

  return el('div',{class:'flex-1 p-4 md:p-6'},
    el('h1',{class:'text-3xl font-extrabold mb-2'},'Client'),
    Breadcrumb([{label:'Dashboard',click:()=>goto('dashboard')},{label:'Clients',click:()=>goto('clients')},{label:c.name,click:()=>goto('client',id)}]),
    el('div',{class:'grid md:grid-cols-2 gap-4'},
      Card('Profile',
        el('div',{},
          el('div',{}, c.name, signBadge),
          el('div',{class:'text-sm text-zinc-600'}, c.phone || ''),
          el('div',{class:'text-sm mt-1'}, 'Pets: '+(pets.map(p=>p.name).join(', ')||'‚Äî'))
        )
      ),
      Card('Recent Appointments',
        el('div',{class:'grid gap-2'},
          ...appts.slice(0,6).map(a => el('button',{class:'text-left rounded-lg border px-3 py-2 hover:bg-zinc-50',
            onclick:()=>goto('appt',a.id)}, `${fmtDate(a.start)} ‚Ä¢ ${fmtTime(a.start)} ‚Äî ${getService(a.serviceId)?.name||''} (${a.status})`)),
          appts.length===0 && el('div',{class:'text-sm text-zinc-500'},'None yet.')
        )
      )
    )
  );
}

/* ===== clients list ===== */
function Clients(){
  seed();
  const wrap=el('div',{class:'grid gap-2'});
  S.clients.forEach(c=>{
    wrap.appendChild(el('button',{class:'text-left rounded-xl2 border border-zinc-200 p-3 bg-white shadow-card hover:bg-zinc-50',
      onclick:()=>goto('client', c.id)},
      el('div',{class:'font-semibold'},c.name),
      el('div',{class:'text-xs text-zinc-500'},c.phone||''),
      el('div',{class:'text-sm mt-1'},'Pets: '+(S.pets.filter(p=>p.clientId===c.id).map(p=>p.name).join(', ')||'‚Äî'))
    ));
  });
  return el('div',{class:'flex-1 p-4 md:p-6'}, el('h1',{class:'text-3xl font-extrabold mb-4'},'Clients'), wrap);
}

/* ===== admin (reports) ===== */
function Admin(){
  seed();
  const range={start:new Date(Date.now()-7*86400000).toISOString().slice(0,10),end:new Date().toISOString().slice(0,10)};
  const startI=el('input',{type:'date',value:range.start,class:'border rounded-xl p-2',oninput:e=>{range.start=e.target.value;rebuild();}});
  const endI=el('input',{type:'date',value:range.end,class:'border rounded-xl p-2',oninput:e=>{range.end=e.target.value;rebuild();}});
  const payEl=el('div',{class:'grid gap-2'}); const scheds=el('div',{class:'grid gap-2'});
  function inRange(iso){const d=iso.slice(0,10);return d>=range.start&&d<=range.end;}
  function payroll(){
    const lines={}; for(const a of S.appointments){
      if(a.status!=='complete'||!inRange(a.start)) continue;
      const svc=getService(a.serviceId); if(!svc) continue;
      const key=a.employeeId; if(!lines[key]) lines[key]={rev:0,pct:svc.pct}; lines[key].rev+=svc.price;
    } return lines;
  }
  function rebuild(){
    payEl.innerHTML=''; const lines=payroll(); const entries=Object.entries(lines);
    if(!entries.length) payEl.appendChild(el('div',{class:'text-sm text-zinc-500'},'No completed appointments in range.'));
    entries.forEach(([empId,v])=>{
      const emp=getEmployee(empId);
      const stylist=v.rev*(v.pct/100); const house=v.rev-stylist;
      payEl.appendChild(el('div',{class:'rounded-xl2 border border-zinc-200 p-3 bg-white shadow-card'},
        el('div',{class:'font-semibold'},emp?.name||'Employee'),
        el('div',{class:'text-sm'},`Revenue: $${v.rev.toFixed(2)} ‚Ä¢ ${v.pct}%`),
        el('div',{class:'text-sm'},`Stylist: $${stylist.toFixed(2)} ‚Ä¢ House: $${house.toFixed(2)}`)
      ));
    });
    scheds.innerHTML=''; S.employees.forEach(e=>{
      const txt=Object.keys(e.schedule).length
        ? Object.entries(e.schedule).map(([d,[o,c]])=>`${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][+d]}: ${o}:00‚Äì${c}:00`).join(' ‚Ä¢ ')
        : 'No hours set';
      scheds.appendChild(el('div',{class:'rounded-xl2 border border-zinc-200 p-3 bg-white shadow-card'},
        el('div',{class:'font-semibold'},e.name),
        el('div',{class:'text-sm'},txt)
      ));
    });
  }
  rebuild();
  return el('div',{class:'flex-1 p-4 md:p-6'},
    el('h1',{class:'text-3xl font-extrabold mb-4'},'Reports'),
    el('div',{class:'flex gap-2 mb-4'},startI,endI),
    el('div',{class:'mb-4'},payEl),
    el('div',{},scheds)
  );
}

/* ===== messages ===== */
function Messages(){
  seed();
  const thread=el('div',{class:'rounded-xl2 border border-zinc-200 p-3 h-72 overflow-auto bg-zinc-50'});
  const input=el('input',{class:'flex-1 border rounded-xl p-2',placeholder:'Type message‚Ä¶'});
  const send=el('button',{class:'px-4 py-2 rounded-xl bg-brand-600 hover:bg-brand-700 text-white tap anim'},'Send');
  function redraw(){
    thread.innerHTML=''; (S.messages||[]).forEach(m=>{
      thread.appendChild(el('div',{class:'mb-2'},
        el('div',{class:'inline-block rounded-lg border border-zinc-200 bg-white px-2 py-1 shadow-sm'},m.body),
        el('div',{class:'text-[10px] text-zinc-500'},new Date(m.sentAt).toLocaleTimeString())
      ));
    }); if(!S.messages.length) thread.appendChild(el('div',{class:'text-sm text-zinc-500'},'No messages yet.'));
  }
  redraw();
  send.addEventListener('click',()=>{const txt=input.value.trim();if(!txt)return;
    S.messages.push({id:uid(),body:txt,sentAt:new Date().toISOString()});input.value='';save();redraw();});
  return el('div',{class:'flex-1 p-4 md:p-6'}, el('h1',{class:'text-3xl font-extrabold mb-4'},'Messages'),
    thread, el('div',{class:'flex gap-2 mt-2'},input,send));
}

/* ===== agreement ===== */
function Agreement(){
  seed();
  const text=el('textarea',{class:'w-full border rounded-xl2 p-3 min-h-[140px]'},
    'I consent to grooming services and acknowledge the policies including cancellation, matted coat fees, and emergency care authorization.'
  );
  const canvas=el('canvas',{class:'w-full h-[220px] rounded-xl2 bg-white border border-zinc-200 shadow-card'}); const ctx=canvas.getContext('2d');
  let drawing=false;
  function resize(){const r=window.devicePixelRatio||1;const w=canvas.clientWidth;const h=220;
    canvas.width=w*r;canvas.height=h*r;ctx.setTransform(r,0,0,r,0,0);} setTimeout(resize,0);window.addEventListener('resize',resize);
  canvas.addEventListener('mousedown',e=>{drawing=true;ctx.beginPath();ctx.moveTo(e.offsetX,e.offsetY);});
  canvas.addEventListener('mousemove',e=>{if(!drawing)return;ctx.lineWidth=2;ctx.lineCap='round';ctx.strokeStyle='#111';
    ctx.lineTo(e.offsetX,e.offsetY);ctx.stroke();ctx.beginPath();ctx.moveTo(e.offsetX,e.offsetY);});
  window.addEventListener('mouseup',()=>drawing=false);
  const preview=el('div',{}); 
  const saveBtn=el('button',{class:'px-4 py-2 rounded-xl bg-brand-600 hover:bg-brand-700 text-white tap anim',
    onclick:()=>{const url=canvas.toDataURL('image/png');preview.innerHTML='';preview.appendChild(el('img',{src:url,class:'max-h-28 rounded-xl border border-zinc-200 shadow-sm'}));}},'Save');
  const clearBtn=el('button',{class:'px-4 py-2 rounded-xl bg-rose-600 text-white tap anim',onclick:()=>{ctx.clearRect(0,0,canvas.width,canvas.height);preview.innerHTML='';}},'Clear');
  const addPhotos=el('button',{class:'px-4 py-2 rounded-xl bg-brand-600 hover:bg-brand-700 text-white tap anim',onclick:()=>alert('Uploads will be enabled when hooked to a backend.')},'Add Photos');
  const addDocs=el('button',{class:'px-4 py-2 rounded-xl bg-brand-600 hover:bg-brand-700 text-white tap anim',onclick:()=>alert('Uploads will be enabled when hooked to a backend.')},'Add Docs');
  const submit=el('button',{class:'px-4 py-2 rounded-xl bg-brand-800 text-white tap anim'},'Submit Agreement');
  return el('div',{class:'flex-1 p-4 md:p-6'},
    el('h1',{class:'text-3xl font-extrabold mb-4'},'Agreement'),
    el('div',{class:'grid gap-4'}, text,
      el('div',{},el('div',{class:'font-medium mb-1'},'Signature'),canvas,el('div',{class:'flex gap-2 mt-2'},saveBtn,clearBtn),preview),
      el('div',{},el('div',{class:'font-medium mb-1'},'Attachments'),el('div',{class:'flex gap-2'},addPhotos,addDocs)),
      submit
    )
  );
}

/* ===== layout + route switch ===== */
function App(){
  return el('div',{class:'min-h-screen flex'},
    Sidebar(),
    Nav.route==='dashboard' ? Dashboard() :
    Nav.route==='book'      ? Book() :
    Nav.route==='calendar'  ? Calendar() :
    Nav.route==='clients'   ? Clients() :
    Nav.route==='admin'     ? Admin() :
    Nav.route==='messages'  ? Messages() :
    Nav.route==='agreement' ? Agreement() :
    Nav.route==='appt'      ? AppointmentDetail(Nav.id) :
    Nav.route==='client'    ? ClientDetail(Nav.id) :
    el('div',{class:'p-6'},'Not found')
  );
}

/* ===== mount ===== */
seed();
function render(){ const root=$('#app'); root.innerHTML=''; root.appendChild(App()); }
render();

/* ===== PWA worker (already in repo root) ===== */

  </script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js');
}
</script>
</body>
</html>
